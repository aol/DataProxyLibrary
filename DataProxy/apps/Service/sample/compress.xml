<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE doc[
<!ENTITY dplTransformerLibPath "/data/lib" >
<!ENTITY endpointName "svc" >
<!ENTITY endpointLocation "http://host:8080/final/endpoint" >
<!ENTITY localDir "./" >
]>

<DplConfig>

	<RouterNode name="/&endpointName;" >
		<Write>
			<!-- compress the incoming data -->
			<StreamTransformers>
				<StreamTransformer path="&dplTransformerLibPath;/libShellStreamTransformer.so" functionName="TransformStream" >
					<Parameter name="timeout" value="60" />
					<Parameter name="command" value="gzip" />
				</StreamTransformer>
			</StreamTransformers>
			<!-- indicate from here that the data is compressed -->
			<TranslateParameters>
				<Parameter name="Content-Encoding" valueOverride="gzip" />
				<Parameter name="applicableTime" valueDefault="`date -u +%s | tr -d [:space:]`" />
			</TranslateParameters>
			<!-- forward the data to node(s) -->
			<ForwardTo name="&endpointName;.primary" critical="true" />
			<!-- UNCOMMENT THIS TO SEND THE COMPRESSED DATA TO A LOCAL STORE AS WELL
			<ForwardTo name="&endpointName;.local" critical="false" />
			-->
		</Write>
	</RouterNode>

	<DataNode name="&endpointName;.local" type="local" location="&localDir;" format="&endpointName;.local.${applicableTime}.gz" />

	<DataNode name="&endpointName;.primary" type="rest" location="&endpointLocation;" >
		<Write timeout="120" >
			<HttpHeaderParameters>
				<Parameter name="Content-Encoding" />
			</HttpHeaderParameters>
			<UriQueryParameters>
				<Parameter name="applicableTime" />
			</UriQueryParameters>
			<OnFailure retryCount="5" />
		</Write>
	</DataNode>

</DplConfig>
