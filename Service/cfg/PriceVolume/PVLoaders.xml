<DplConfig>

	<DatabaseConnections>
		<Database type="oracle"
			connection="ace"
			name="edwprd"
			user="toad"
			password="axxess"
			schema="ACE" />

		<Database type="oracle"
			connection="adlapp_ace"
			name="adlapp"
			user="nacon_user"
			password="frogfish09"
			schema="ACE" />
	</DatabaseConnections>

	<DataNode name="CampaignFrequencyCapService" type="rest" location="http://m-tst-adlibpricevol01.advertising.aol.com:50018/campaign_frequency_cap" >
		<Write timeout="259200" uriSuffix="" >
			<TranslateParameters>
				<Parameter name="applicableTime" valueDefault="`date -u +%Y%m%dT%H%M%S | tr -d [:space:]`"/>
			</TranslateParameters>
			<UriQueryParameters>
				<Parameter name="applicableTime" />
				<Parameter name="fullDataset" />
			</UriQueryParameters>
		</Write>
	</DataNode>

	<DataNode name="MediaFrequencyCapService" type="rest" location="http://m-tst-adlibpricevol01.advertising.aol.com:50013/media_frequency_cap" >
		<Write timeout="259200" uriSuffix="" >
			<TranslateParameters>
				<Parameter name="applicableTime" valueDefault="`date -u +%Y%m%dT%H%M%S | tr -d [:space:]`"/>
			</TranslateParameters>
			<UriQueryParameters>
				<Parameter name="applicableTime" />
				<Parameter name="fullDataset" />
			</UriQueryParameters>
		</Write>
	</DataNode>

	<DataNode name="MediaElementsTargetingService" type="rest" location="http://m-tst-adlibpricevol01.advertising.aol.com:50014/media_element_targeting" >
		<Write timeout="259200" uriSuffix="" >
			<TranslateParameters>
				<Parameter name="applicableTime" valueDefault="`date -u +%Y%m%dT%H%M%S | tr -d [:space:]`"/>
			</TranslateParameters>
			<UriQueryParameters>
				<Parameter name="applicableTime" />
				<Parameter name="fullDataset" />
			</UriQueryParameters>
		</Write>
	</DataNode>

<DataNode name="CampaignFrequencyCapDbQuery" type="db" >
  <Read connection="ace"
    header="campaign_id,scope,rolling_window_limit,rolling_window_hours,lifetime_limit,dont_show_if_clicked,dont_show_if_converted"
    query="SELECT  campaign_id,
      scope,
      MAX(rolling_window_limit),
      MAX(rolling_window_hours),
      MAX(lifetime_limit),
      MAX(dont_show_if_clicked),
      MAX(dont_show_if_converted) 
FROM
(SELECT campaign_id,
  (CASE
    WHEN frequency_capping_rule_id = 1 OR frequency_capping_rule_id = 3 OR frequency_capping_rule_id = 5
    THEN 1
    WHEN frequency_capping_rule_id = 2 OR frequency_capping_rule_id = 4 OR frequency_capping_rule_id = 6 OR frequency_capping_rule_id = 7
    THEN 0
  END) scope,
  (CASE
    WHEN frequency_capping_rule_id = 3 OR frequency_capping_rule_id = 4
    THEN rule_value_2
    ELSE NULL
  END) rolling_window_limit,
  (CASE
    WHEN frequency_capping_rule_id = 3 OR frequency_capping_rule_id = 4
    THEN (rule_value_1 / 60)
    ELSE NULL
  END) rolling_window_hours,
  (CASE
    WHEN frequency_capping_rule_id = 1 OR frequency_capping_rule_id = 2
    THEN (rule_value_1)
    ELSE NULL
  END) lifetime_limit,
  (CASE
    WHEN frequency_capping_rule_id = 5 OR frequency_capping_rule_id = 6
    THEN 1
    ELSE NULL
  END) dont_show_if_clicked,
  (CASE
    WHEN frequency_capping_rule_id = 7
    THEN 1
    ELSE NULL
  END) dont_show_if_converted
FROM ACE.T_CAMP_FREQUENCY_CAPPING_RULE f INNER JOIN ace.adcampaign c on (f.campaign_id = c.id)
WHERE active_ind = 1 AND c.enddate > gmtsysdate)
GROUP BY (campaign_id, scope)" >
  </Read>
</DataNode>

<DataNode name="MediaFrequencyCapDbQuery" type="db" >
  <Read connection="ace"
    header="media_id,rolling_window_limit,rolling_window_hours,lifetime_limit,dont_show_if_clicked"
    query="SELECT media_id,
                  MAX(rolling_window_limit),
                  MAX(rolling_window_hours),
                  MAX(lifetime_limit),
                  MAX(dont_show_if_clicked)
           FROM
            (SELECT media_id,
                   CASE frequency_capping_rule_id
                     WHEN 3 THEN RULE_VALUE_2
                     ELSE NULL
                   END AS rolling_window_limit,
                   CASE frequency_capping_rule_id
                      WHEN 3 THEN RULE_VALUE_1/60
                      ELSE NULL
                    END AS rolling_window_hours,
                    CASE frequency_capping_rule_id
                      WHEN 1 THEN RULE_VALUE_1
                      ELSE NULL
                    END AS lifetime_limit,
                    CASE frequency_capping_rule_id
                      WHEN 5 THEN 1
                      ELSE NULL
                    END AS dont_show_if_clicked
             FROM ace.t_media_frequency_capping_rule mfcr
			 JOIN ace.admedia am
			 ON mfcr.media_id = am.adid
             WHERE active_ind = 1 AND am.adenddate > gmtsysdate)
             GROUP BY media_id" >
  </Read>
</DataNode>

<DataNode name="MediaElementsTargetingDbQuery" type="db" >
  <Read connection="ace"
    header="media_id,axis_id,element_type,element_id,include"
    query="SELECT megalist.media_id,
                  CASE
                    WHEN eamap.elements_type_resolution_id = 2 THEN 0
                    ELSE eamap.root_id
                  END,
                  ele.elements_type_id,
                  megalist.elements_id,
                  megalist.include
           FROM 
            (SELECT mlist.adid AS media_id,
                    CASE
                      WHEN ate.elements_id IS NOT NULL THEN ate.elements_id
                      ELSE cte.elements_id
                    END AS elements_id,
                    CASE
                      WHEN ate.elements_id IS NOT NULL THEN ate.target_this_value_ind
                      ELSE cte.target_this_value_ind
                    END AS include
             FROM ace.admedia mlist
             LEFT JOIN ace.t_media_target_elements ate
             ON mlist.adid = ate.media_id AND ate.active_ind = 1
             LEFT JOIN ace.t_camp_target_elements cte
             ON mlist.campaignid = cte.campaign_id AND cte.active_ind = 1 AND ate.media_id IS NULL
             WHERE (ate.elements_id IS NOT NULL OR cte.elements_id IS NOT NULL)
			        AND mlist.adenddate > gmtsysdate) megalist
             INNER JOIN ace.t_elements ele
             ON megalist.elements_id = ele.elements_id
             INNER JOIN
              (SELECT elements_type_id,
                      elements_type_resolution_id,
                      CONNECT_BY_ROOT elements_type_id AS root_id
               FROM ACE.t_elements_type
               START WITH parent_elements_type_id IS NULL
               CONNECT BY PRIOR elements_type_id = parent_elements_type_id) eamap
             ON ele.elements_type_id = eamap.elements_type_id" >
  </Read>
</DataNode>
</DplConfig>
